name: Knowledge Base Update

# Trigger on push to develop or main branches
on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'knowledge/**'
  workflow_dispatch:

jobs:
  # Job 1: Generate knowledge index
  generate-index:
    name: Generate Knowledge Index
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Generate knowledge index
        run: |
          echo "Generating knowledge base index..."

          INDEX_FILE="knowledge/INDEX.md"
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')

          # Create index header
          cat > "$INDEX_FILE" <<EOF
          # Knowledge Base Index

          **Last Updated:** $TIMESTAMP
          **Branch:** ${GITHUB_REF#refs/heads/}
          **Commit:** ${GITHUB_SHA:0:7}

          ---

          ## Standards

          EOF

          # List standards
          if [[ -d "knowledge/standards" ]]; then
            find knowledge/standards -name "*.md" -type f | sort | while read -r file; do
              filename=$(basename "$file")
              title=$(grep -m 1 "^#" "$file" | sed 's/^#* *//' || echo "$filename")
              echo "- [\`$filename\`]($file) - $title" >> "$INDEX_FILE"
            done
          else
            echo "_No standards yet_" >> "$INDEX_FILE"
          fi

          # Reports section
          cat >> "$INDEX_FILE" <<EOF

          ## Reports

          EOF

          if [[ -d "knowledge/reports" ]]; then
            find knowledge/reports -name "*.md" -type f | sort -r | while read -r file; do
              filename=$(basename "$file")
              title=$(grep -m 1 "^#" "$file" | sed 's/^#* *//' || echo "$filename")
              echo "- [\`$filename\`]($file) - $title" >> "$INDEX_FILE"
            done
          else
            echo "_No reports yet_" >> "$INDEX_FILE"
          fi

          # Tasks section
          cat >> "$INDEX_FILE" <<EOF

          ## Pending Tasks

          EOF

          if [[ -d "knowledge/tasks" ]]; then
            find knowledge/tasks -name "PENDING-TASK-*.md" -type f | sort | while read -r file; do
              filename=$(basename "$file")
              title=$(grep -m 1 "^#" "$file" | sed 's/^#* *//' || echo "$filename")
              status=$(grep -i "status:" "$file" | head -1 | sed 's/.*: *//' || echo "Unknown")
              echo "- [\`$filename\`]($file) - $title (Status: $status)" >> "$INDEX_FILE"
            done
          else
            echo "_No pending tasks_" >> "$INDEX_FILE"
          fi

          # Add statistics
          cat >> "$INDEX_FILE" <<EOF

          ---

          ## Statistics

          - **Total Standards:** $(find knowledge/standards -name "*.md" 2>/dev/null | wc -l)
          - **Total Reports:** $(find knowledge/reports -name "*.md" 2>/dev/null | wc -l)
          - **Total Tasks:** $(find knowledge/tasks -name "*.md" 2>/dev/null | wc -l)
          - **Total Documents:** $(find knowledge -name "*.md" 2>/dev/null | wc -l)

          ---

          _This index is automatically generated by GitHub Actions_
          EOF

          echo "âœ“ Knowledge index generated: $INDEX_FILE"

      - name: Upload index as artifact
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-index
          path: knowledge/INDEX.md

  # Job 2: Calculate repository metrics
  update-metrics:
    name: Update Repository Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for metrics

      - name: Calculate metrics
        run: |
          echo "Calculating repository metrics..."

          METRICS_FILE="knowledge/reports/REPOSITORY-METRICS.md"
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')

          # Branch counts
          TOTAL_BRANCHES=$(git branch -a | grep -v HEAD | wc -l)
          LOCAL_BRANCHES=$(git branch | wc -l)
          REMOTE_BRANCHES=$(git branch -r | grep -v HEAD | wc -l)

          # Commit statistics
          TOTAL_COMMITS=$(git rev-list --all --count)
          LAST_COMMIT=$(git log -1 --format="%h - %s (%an, %ar)")

          # File statistics
          TOTAL_FILES=$(find . -type f -not -path "./.git/*" | wc -l)
          MARKDOWN_FILES=$(find . -name "*.md" -not -path "./.git/*" | wc -l)
          SCRIPT_FILES=$(find . -name "*.sh" -not -path "./.git/*" | wc -l)

          # Knowledge base size
          KB_SIZE=$(du -sh knowledge 2>/dev/null | cut -f1 || echo "0")

          # Create metrics report
          cat > "$METRICS_FILE" <<EOF
          # Repository Metrics

          **Generated:** $TIMESTAMP
          **Branch:** ${GITHUB_REF#refs/heads/}

          ---

          ## Git Metrics

          | Metric | Value |
          |--------|-------|
          | Total Branches | $TOTAL_BRANCHES |
          | Local Branches | $LOCAL_BRANCHES |
          | Remote Branches | $REMOTE_BRANCHES |
          | Total Commits | $TOTAL_COMMITS |
          | Last Commit | $LAST_COMMIT |

          ## File Metrics

          | Type | Count |
          |------|-------|
          | Total Files | $TOTAL_FILES |
          | Markdown Files | $MARKDOWN_FILES |
          | Shell Scripts | $SCRIPT_FILES |
          | Knowledge Base Size | $KB_SIZE |

          ## Knowledge Base Metrics

          | Category | Count |
          |----------|-------|
          | Standards | $(find knowledge/standards -name "*.md" 2>/dev/null | wc -l) |
          | Reports | $(find knowledge/reports -name "*.md" 2>/dev/null | wc -l) |
          | Tasks | $(find knowledge/tasks -name "*.md" 2>/dev/null | wc -l) |

          ---

          _Metrics automatically updated on push to main/develop_
          EOF

          echo "âœ“ Metrics updated: $METRICS_FILE"

      - name: Upload metrics as artifact
        uses: actions/upload-artifact@v4
        with:
          name: repository-metrics
          path: knowledge/reports/REPOSITORY-METRICS.md

  # Job 3: Notify on update
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [generate-index, update-metrics]

    steps:
      - name: Create summary
        run: |
          echo "### Knowledge Base Updated! ðŸ“š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow artifacts for updated index and metrics." >> $GITHUB_STEP_SUMMARY

      - name: Post completion message
        run: |
          echo "=========================================="
          echo "  Knowledge Base Update Complete"
          echo "=========================================="
          echo ""
          echo "âœ“ Index generated"
          echo "âœ“ Metrics updated"
          echo "âœ“ Summary created"
          echo ""
          echo "View artifacts in the Actions tab."
